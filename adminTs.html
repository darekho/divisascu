<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Admin - DivisasCU</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f4f4f4; }
        input, select { width: 100%; padding: 5px; box-sizing: border-box; }
        .save-btn { 
            padding: 10px 20px; 
            background: #4CAF50; 
            color: white; 
            border: none; 
            cursor: pointer; 
            font-size: 16px;
        }
        .save-btn:hover { background: #45a049; }
    </style>
</head>
<body>
    <h1>Editor de Tasas de Cambio</h1>
    
    <table id="ratesTable">
        <thead>
            <tr>
                <th>Moneda</th>
                <th>Rate</th>
                <th>Delta</th>
                <th>Trend</th>
            </tr>
        </thead>
        <tbody>
            <!-- Las filas se generarán con JavaScript -->
        </tbody>
    </table>

    <button class="save-btn" onclick="saveData()">Guardar Cambios</button>
    <p id="message"></p>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Configuración de Firebase - USA TU CONFIGURACIÓN
        const firebaseConfig = {
            apiKey: "AIzaSyAs9_tC5QXCXlZK5c76apCMBQDfR9hiHWk",
            authDomain: "divisascu-9ef29.firebaseapp.com",
            projectId: "divisascu-9ef29",
            storageBucket: "divisascu-9ef29.firebasestorage.app",
            messagingSenderId: "674858237080",
            appId: "1:674858237080:web:944ff6d1f80eb8718ca4ed"
        };
        
        // Inicializar Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Variable global para almacenar datos
        let currentData = [];

        // Cargar datos iniciales
        async function loadData() {
            try {
                const docRef = db.collection("scriptUpdates").doc("latestVersion");
                const docSnap = await docRef.get();
                
                if (docSnap.exists) {
                    currentData = docSnap.data().code;
                    renderTable();
                } else {
                    console.log("No se encontraron datos!");
                }
            } catch (error) {
                console.error("Error loading data:", error);
            }
        }

        // Renderizar tabla editable
        function renderTable() {
            const tbody = document.querySelector("#ratesTable tbody");
            tbody.innerHTML = "";

            currentData.forEach((currency, index) => {
                const tr = document.createElement("tr");
                
                tr.innerHTML = `
                    <td>
                        <img src="${currency.flag}" width="30" height="20" style="vertical-align: middle;">
                        ${currency.label} (${currency.code})
                    </td>
                    <td><input type="number" step="0.01" value="${currency.rate}" 
                           onchange="updateField(${index}, 'rate', this.value)"></td>
                    <td><input type="number" step="0.01" value="${currency.delta}" 
                           onchange="updateField(${index}, 'delta', this.value)"></td>
                    <td>
                        <select onchange="updateField(${index}, 'trend', this.value)">
                            <option value="up" ${currency.trend === 'up' ? 'selected' : ''}>↑ Up</option>
                            <option value="down" ${currency.trend === 'down' ? 'selected' : ''}>↓ Down</option>
                            <option value="neutral" ${currency.trend === 'neutral' ? 'selected' : ''}>→ Neutral</option>
                        </select>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        // Actualizar campo en tiempo real
        function updateField(index, field, value) {
            if (field === 'rate' || field === 'delta') {
                value = parseFloat(value);
            }
            currentData[index][field] = value;
        }

        // Guardar en Firebase
        async function saveData() {
            try {
                await db.collection("scriptUpdates").doc("latestVersion").set({
                    code: currentData,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                document.getElementById("message").textContent = "✅ Datos guardados correctamente!";
                setTimeout(() => {
                    document.getElementById("message").textContent = "";
                }, 3000);
            } catch (error) {
                console.error("Error saving data:", error);
                document.getElementById("message").textContent = "❌ Error al guardar: " + error.message;
            }
        }

        // Cargar datos al iniciar
        loadData();
    </script>
</body>
</html>